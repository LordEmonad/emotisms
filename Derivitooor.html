<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derivitooor - Ordtism</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
          --bg-color: #101025;
          --bg-gradient: radial-gradient(ellipse at 50% 0%, #2e2e56 0%, transparent 70%),
            radial-gradient(ellipse at 50% 100%, #2a1a36 0%, transparent 70%),
            radial-gradient(ellipse at 80% 30%, #ffd58033 0%, transparent 80%),
            #101025;
          --text-color: #f5f5fa;
          --accent-color: #c7a8ff;
          --accent-gradient: linear-gradient(90deg, #ffd580 0%, #c7a8ff 60%, #44ffe2 100%);
          --secondary-color: #44ffe2;
          --gold: #ffd580;
          --violet: #c7a8ff;
          --teal: #44ffe2;
          --card-bg: rgba(22,24,40,0.84);
          --card-hover: rgba(40,30,60,0.97);
          --border-color: #c7a8ff;
          --info-color: #ffd580;
          --button-bg: rgba(22,24,40,0.92);
          --button-text: #ffd580;
          --button-border: #c7a8ff;
          --button-glow: 0 0 12px 2px #c7a8ff66;
          --modal-bg: #18183a;
          --modal-border: #ffd580;
        }
        
        /* Enhanced Mint on Gamma button - Subtle but noticeable */
        .mint-gamma-btn {
          position: relative;
          overflow: visible;
          font-weight: 600 !important;
          border: 3px solid transparent !important;
          background: linear-gradient(var(--button-bg), var(--button-bg)) padding-box,
                      linear-gradient(45deg, #ffd580, #c7a8ff, #44ffe2, #ffd580) border-box;
          background-size: auto, 300% 300%;
          animation: borderGlow 3s ease-in-out infinite;
          transition: all 0.4s ease-in-out;
        }
        
        /* Enhanced glow layer */
        .mint-gamma-btn::before {
          content: '';
          position: absolute;
          top: -6px;
          left: -6px;
          right: -6px;
          bottom: -6px;
          background: linear-gradient(45deg, #ffd580, #c7a8ff, #44ffe2, #ffd580);
          background-size: 300% 300%;
          border-radius: 999px;
          z-index: -1;
          animation: gammaGlow 3s ease-in-out infinite;
          opacity: 1;
          filter: blur(3px);
          transition: all 0.4s ease-in-out;
        }
        
        /* Border animation for the button itself */
        @keyframes borderGlow {
          0%, 100% {
            background-position: auto, 0% 50%;
          }
          50% {
            background-position: auto, 100% 50%;
          }
        }
        
        /* Glow animation - enhanced visibility */
        @keyframes gammaGlow {
          0%, 100% {
            background-position: 0% 50%;
            box-shadow: 0 0 25px rgba(255, 213, 128, 0.9), 0 0 45px rgba(199, 168, 255, 0.7), 0 0 65px rgba(255, 213, 128, 0.5);
          }
          50% {
            background-position: 100% 50%;
            box-shadow: 0 0 30px rgba(199, 168, 255, 0.9), 0 0 50px rgba(68, 255, 226, 0.7), 0 0 70px rgba(199, 168, 255, 0.5);
          }
        }
        
        /* Enhanced hover state */
        .mint-gamma-btn:hover {
          background: linear-gradient(90deg, #18183a 0%, #2e2e56 100%) !important;
          border: 3px solid #44ffe2 !important;
          color: #44ffe2;
          box-shadow: 0 0 15px rgba(199, 168, 255, 0.6);
          transform: translateY(-2px);
          animation: none;
        }
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }
        body {
            font-family: 'Space Grotesk', sans-serif;
            display: flex;
            flex-direction: column; /* Change body to column layout */
            margin: 0;
            height: 100vh;
            background: var(--bg-gradient);
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        #controls-container {
            display: flex;
            flex-direction: row; /* Arrange control columns side-by-side */
            height: 100%; /* Fill height of parent (#main-content) */
        }
        #controls, #color-controls {
            width: 300px; /* Slightly wider */
            padding: 25px;
            background: var(--card-bg);
            box-shadow: 0 6px 32px 0 #000a, 0 0 0 1px #44ffe222;
            border-right: 2px solid var(--border-color); /* Add border */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 18px; /* Add space between control groups */
            position: relative; /* Added for positioning context of close button */
            height: 100%;
            transition: transform 0.3s ease-in-out; /* Add transition for smooth toggling */
        }
        #controls.hidden {
            transform: translateX(-100%); /* Hide controls by moving off-screen */
        }
        #preview {
            flex-grow: 1;
            background-color: var(--bg-color); /* Add background to preview area */
        }
        iframe {
            flex-grow: 1;
            border: none;
            width: 100%;
            height: 100%;
        }
        label {
            display: block;
            margin-bottom: 8px; /* Increased space */
            font-weight: 600; /* Adjusted weight */
            color: var(--accent-color); /* Themed color */
        }
        input[type="range"], input[type="number"] {
            width: 100%; /* Full width */
            margin-bottom: 8px; /* Increased space */
            cursor: pointer;
        }
        /* Range Slider Styles */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: rgba(16, 16, 37, 0.7); /* Dark track */
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--gold); /* Gold thumb */
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--bg-color);
            box-shadow: 0 0 5px var(--gold);
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--gold);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--bg-color);
            box-shadow: 0 0 5px var(--gold);
        }
        /* Number Input Styles */
        input[type="number"] {
             padding: 8px 10px; /* Increased padding */
             border: 1.5px solid var(--border-color); /* Themed border */
             border-radius: 5px;
             background-color: var(--button-bg); /* Themed background */
             color: var(--text-color); /* Themed text */
             font-family: 'Space Grotesk', sans-serif;
             font-size: 0.95em;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 8px var(--gold);
        }
        .control-group {
            border: 1.5px solid var(--border-color); /* Themed border */
            padding: 15px; /* Increased padding */
            border-radius: 8px; /* More rounded */
            background-color: rgba(22, 24, 40, 0.7); /* Darker themed background */
            backdrop-filter: blur(2px);
        }
        .value-display {
            font-style: normal; /* Removed italic */
            color: var(--gold); /* Themed color */
            font-size: 0.95em; /* Slightly larger */
            margin-left: 8px;
            font-weight: 500;
        }
        /* Button Styles */
        button {
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--button-border);
            border-radius: 999px; /* Pill shape */
            padding: 10px 22px; /* Adjusted padding */
            font-size: 1rem; /* Adjusted size */
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.25s ease;
            box-shadow: var(--button-glow);
            margin-top: 15px; /* Increased space */
            text-align: center;
        }
        button:hover {
            background: linear-gradient(90deg, #18183a 0%, #2e2e56 100%);
            color: var(--teal);
            border-color: var(--teal);
            box-shadow: 0 0 15px rgba(199, 168, 255, 0.6);
            transform: translateY(-2px);
        }
        h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--border-color); /* Themed border */
            padding-bottom: 10px; /* Increased padding */
            font-size: 1.4em; /* Larger */
            color: var(--gold); /* Themed color */
            margin-bottom: 10px; /* Space below title */
        }
        /* Custom scrollbar for controls */
        #controls::-webkit-scrollbar {
          width: 8px;
        }
        #controls::-webkit-scrollbar-track {
          background: rgba(0,0,0,0.2);
          border-radius: 4px;
        }
        #controls::-webkit-scrollbar-thumb {
          background-color: var(--accent-color);
          border-radius: 4px;
          border: 2px solid var(--card-bg);
        }

        /* Navigation Bar Styles - Copied from index.html */
        .nav-bar {
          display: flex;
          justify-content: center;
          margin: 15px 0 10px 0; /* Adjusted margins */
          padding: 10px 0;
          flex-shrink: 0; /* Prevent nav bar from shrinking */
          width: 100%;
        }

        .nav-buttons {
          display: flex;
          gap: 15px;
          flex-wrap: wrap;
          justify-content: center;
        }

        .nav-button {
          background: var(--button-bg);
          color: var(--button-text);
          border: 2px solid var(--button-border);
          border-radius: 999px;
          padding: 8px 22px;
          font-size: 0.96rem;
          font-weight: 600;
          cursor: pointer;
          text-decoration: none;
          transition: all 0.25s ease;
          box-shadow: var(--button-glow);
        }

        .nav-button:hover {
          background: linear-gradient(90deg, #18183a 0%, #2e2e56 100%);
          color: #44ffe2;
          border-color: #44ffe2;
          box-shadow: 0 0 15px rgba(199, 168, 255, 0.6);
          transform: translateY(-2px);
        }

        @media (max-width: 700px) {
          .nav-buttons {
            gap: 8px;
          }

          .nav-button {
            padding: 7px 12px;
            font-size: 0.8rem;
          }
        }

        @media (max-width: 400px) {
          .nav-buttons {
            gap: 6px;
          }

          .nav-button {
            padding: 5px 8px;
            font-size: 0.7rem;
          }
        }
        /* End Navigation Bar Styles */

        /* Styles for main content area below nav */
        #main-content {
            display: flex;
            flex-grow: 1; /* Take remaining height */
            overflow: hidden; /* Prevent content overflow */
            /* Height calculation removed, flex-grow handles it */
        }

        /* Mobile Controls Nav Bar */
        #mobile-controls-nav {
            display: none; /* Hidden by default */
            padding: 8px 10px;
            background-color: rgba(16, 16, 37, 0.85);
            backdrop-filter: blur(3px);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        .mobile-control-btn {
            background: var(--button-bg);
            color: var(--button-text);
            border: 1.5px solid var(--button-border);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--button-glow);
            flex-grow: 1; /* Allow buttons to take space */
            text-align: center;
            max-width: 150px; /* Limit button width */
        }
        .mobile-control-btn:hover {
            background: linear-gradient(90deg, #18183a 0%, #2e2e56 100%);
            color: #44ffe2;
            border-color: #44ffe2;
        }
        .close-panel-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: var(--button-bg);
            border: 1.5px solid var(--button-border);
            color: var(--button-text);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 50%;
            padding: 0;
            margin: 0;
            line-height: 28px;
            text-align: center;
            z-index: 10; /* Ensure it's above panel content */
        }
        .close-panel-btn:hover {
             color: #ffd580;
             border-color: #ffd580;
             background: #18183a;
        }
        /* End Mobile Controls Nav Bar */

        /* Class for visible mobile panels */
        .panel-visible {
            display: flex !important; /* Use important to ensure override */
        }

        /* Mobile Optimizations */
        @media (max-width: 700px) {
            body {
                /* height: auto; Removed - let flexbox handle height */
                min-height: 100vh;
            }
            #mobile-controls-nav {
                display: flex; /* Show mobile nav */
            }
            /* #main-content rule removed as it was empty */
            /* #controls-container rule removed as it was empty */
            /* Style panels as overlays */
            #controls, #color-controls {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000; /* High z-index */
                background-color: rgba(16, 16, 37, 0.30); /* Further adjusted transparency */
                backdrop-filter: blur(2px); /* Reduced blur */
                padding: 20px;
                padding-top: 50px; /* Space for close button */
                border-right: none;
                border-bottom: none;
                display: none; /* Hidden by default */
                overflow-y: auto;
                gap: 15px; /* Restore gap */
                max-height: 100vh; /* Allow full height */
            }
            #preview {
                 /* Preview takes full space in #main-content */
                 height: 100%;
                 min-height: 0; /* Reset min-height */
                 flex-grow: 1; /* Allow preview to grow */
                 height: 100%; /* Ensure preview fills main-content height */
            }
             h2 {
                font-size: 1.2em; /* Smaller headings */
                padding-bottom: 8px;
                margin-bottom: 8px;
            }
            .control-group {
                padding: 10px; /* Reduce padding */
            }
            button {
                padding: 8px 18px;
                font-size: 0.9rem;
                margin-top: 10px;
            }
            .nav-bar {
                margin: 10px 0 0 0; /* Adjust nav margins */
                padding-bottom: 5px;
            }
            /* Hide original randomize button on mobile */
            #controls #randomizeButton {
                display: none;
            }
            
            .mint-gamma-btn::before {
              top: -2px;
              left: -2px;
              right: -2px;
              bottom: -2px;
            }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
      <div class="nav-buttons">
        <a href="index.html" class="nav-button">Home</a>
        <a href="ordtisms.html" class="nav-button">Ordtisms</a>
        <a href="rare tisms/index.html" class="nav-button">Rare Tisms</a>
        <a href="https://beta.gamma.io/ordinals/collections/ordtisms/items" class="nav-button mint-gamma-btn" target="_blank">Mint on Gamma</a>
      </div>
    </nav>
    <div id="mobile-controls-nav">
        <button id="mobileParamsBtn" class="mobile-control-btn">Parameters</button>
        <button id="mobileColorsBtn" class="mobile-control-btn">Colors</button>
        <button id="mobileRandomizeBtn" class="mobile-control-btn">Randomize</button>
    </div>
    <div id="main-content"> <!-- Wrapper start -->
    <div id="controls-container">
        <div id="controls">
            <button class="close-panel-btn" onclick="closePanel('controls')">×</button>
            <h2>Derivitooor Controls</h2>

            <div class="control-group">
                <label for="lobeCount">Lobe Count: <span id="lobeCountValue" class="value-display">2</span></label>
                <input type="range" id="lobeCount" name="lobeCount" min="1" max="15" value="2" step="1">
            </div>

            <div class="control-group">
                <label for="turbulence">Turbulence: <span id="turbulenceValue" class="value-display">1.67</span></label>
                <input type="range" id="turbulence" name="turbulence" min="0.1" max="3.0" value="1.67" step="0.01">
            </div>

            <div class="control-group">
                <label for="ribbonCount">Ribbon Count: <span id="ribbonCountValue" class="value-display">9</span></label>
                <input type="range" id="ribbonCount" name="ribbonCount" min="1" max="20" value="9" step="1">
            </div>

            <div class="control-group">
                <label for="rotSpeed">Rotation Speed: <span id="rotSpeedValue" class="value-display">0.0000</span></label>
                <input type="range" id="rotSpeed" name="rotSpeed" min="0" max="0.001" value="0" step="0.0001">
            </div>

            <div class="control-group" style="text-align: center;">
                <button id="randomizeButton" style="margin: 5px;">Randomize</button>
                <button id="downloadButton" style="margin: 5px;">Download html</button>
                <button id="downloadOrdinalButton" style="margin: 5px;">Download Ordinal html</button>
            </div>
        </div>
        <div id="color-controls">
             <button class="close-panel-btn" onclick="closePanel('color-controls')">×</button>
            <h2>Color Controls</h2>
            <div class="control-group">
                <label for="bgColor1">Background Color 1:</label>
                <input type="color" id="bgColor1" name="bgColor1" value="#131316">
            </div>
            <div class="control-group">
                <label for="bgColor2">Background Color 2:</label>
                <input type="color" id="bgColor2" name="bgColor2" value="#131316">
            </div>
            <div class="control-group">
                <label for="ribbonColor">Ribbon Color:</label>
                <input type="color" id="ribbonColor" name="ribbonColor" value="#673ab7">
            </div>
        </div>
    </div>

    <div id="preview">
        <iframe id="ordtismFrame" src="ORDTISM 1.html"></iframe>
    </div> <!-- Wrapper end -->

    <script>
        const iframe = document.getElementById('ordtismFrame');
        const controls = {
            lobeCount: document.getElementById('lobeCount'),
            turbulence: document.getElementById('turbulence'),
            ribbonCount: document.getElementById('ribbonCount'),
            rotSpeed: document.getElementById('rotSpeed'),
            bgColor1: document.getElementById('bgColor1'),
            bgColor2: document.getElementById('bgColor2'),
            ribbonColor: document.getElementById('ribbonColor')
        };
        const valueDisplays = {
            lobeCount: document.getElementById('lobeCountValue'),
            turbulence: document.getElementById('turbulenceValue'),
            ribbonCount: document.getElementById('ribbonCountValue'),
            rotSpeed: document.getElementById('rotSpeedValue')
        };
        const randomizeButton = document.getElementById('randomizeButton'); // Desktop randomize
        const mobileParamsBtn = document.getElementById('mobileParamsBtn');
        const mobileColorsBtn = document.getElementById('mobileColorsBtn');
        const mobileRandomizeBtn = document.getElementById('mobileRandomizeBtn');
        const controlsPanel = document.getElementById('controls');
        const colorControlsPanel = document.getElementById('color-controls');
        const downloadButton = document.getElementById('downloadButton');
        const downloadOrdinalButton = document.getElementById('downloadOrdinalButton');


        // --- Download Logic ---
        function downloadArt(useOrdinalScript) {
            // 1. Get current parameter values from the UI controls
            const params = {
                lobeCount: controls.lobeCount.value,
                turbulence: controls.turbulence.value,
                ribbonCount: controls.ribbonCount.value,
                rotSpeed: controls.rotSpeed.value,
                bgColor1: controls.bgColor1.value,
                bgColor2: controls.bgColor2.value,
                ribbonColor: controls.ribbonColor.value
            };

            const scriptSrc = useOrdinalScript 
                ? '/content/13a5c8e41dfc110514b450b2f15317988c0aaf276d3dbdcca9aa3c7d0b2188a7i0' 
                : 'https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js';

            const fileName = useOrdinalScript ? 'ORDTISM-ordinal.html' : 'ORDTISM-creation.html';

            // 2. Create the HTML content from a template string
            const htmlTemplate = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ORDTISM Creation</title>
  <script src="${scriptSrc}"><\/script>
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; background: #131316; width: 100%; height: 100%; }
    canvas { display: block; width: 100% !important; height: 100% !important; }
  </style>
</head>
<body>
<script>
    let t = 0,
      rot = 0,
      baseRadius = 0,
      lastFrameTime = 0,
      deltaFrameTime = 0,
      smoothedFrameRate = 60,
      lobeCount = ${params.lobeCount},
      turbulence = ${params.turbulence},
      ribbonCount = ${params.ribbonCount},
      rotSpeed = ${params.rotSpeed},
      radiusScale, sinScale, strokeBase;
      
    const ribbonBaseColorHex = '${params.ribbonColor}';
    const bgColor1Hex = '${params.bgColor1}';
    const bgColor2Hex = '${params.bgColor2}';

    function hexToHsb(hex) {
        const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);
        if (!result) return { h: 0, s: 0, b: 0 }; // Return black on error
        let r = parseInt(result[1], 16);
        let g = parseInt(result[2], 16);
        let b = parseInt(result[3], 16);

        r /= 255;
        g /= 255;
        b /= 255;

        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h, s, v = max;

        const d = max - min;
        if (max === min) {
        h = 0; // achromatic
        } else {
        switch (max) {
            case r:
            h = (g - b) / d + (g < b ? 6 : 0);
            break;
            case g:
            h = (b - r) / d + 2;
            break;
            case b:
            h = (r - g) / d + 4;
            break;
        }
        h /= 6;
        }

        s = max === 0 ? 0 : d / max;

        return {
        h: h * 360,
        s: s * 100,
        b: v * 100
        };
    }

    function setup() {
      pixelDensity(1);
      let r = createCanvas(window.innerWidth, window.innerHeight);
      r.drawingContext.imageSmoothingEnabled = true;
      r.drawingContext.imageSmoothingQuality = 'high';
      calcBaseRadius();
      colorMode(HSB, 360, 100, 100, 100);
      frameRate(60);
      noiseDetail(4, 0.5);
      lastFrameTime = millis();
    }

    function windowResized() {
      resizeCanvas(window.innerWidth, window.innerHeight);
      calcBaseRadius();
    }

    function calcBaseRadius() {
      baseRadius = min(width, height) * 0.2;
      radiusScale = baseRadius * 0.93;
      sinScale = baseRadius * 0.4;
      strokeBase = baseRadius / 180;
    }

    function drawRadialBackground() {
        const e=drawingContext,t=width/2,l=height/2,o=1.8*max(width,height);
        const r=hexToHsb(bgColor1Hex) || {h:0,s:0,b:0};
        const a=hexToHsb(bgColor2Hex) || {h:0,s:0,b:0};
        const n=hexToHsb(bgColor2Hex) || {h:0,s:0,b:0};
        const s=e.createRadialGradient(t,l,.05*o,t,l,o);
        s.addColorStop(0,\`hsla(\${r.h},\${r.s}%,\${r.b}%,1)\`);
        s.addColorStop(.5,\`hsla(\${a.h},\${a.s}%,\${a.b}%,.9)\`);
        s.addColorStop(1,\`hsla(\${n.h},\${n.s}%,\${n.b}%,1)\`);
        e.resetTransform();
        e.fillStyle=s;
        e.fillRect(0,0,width,height);
    }

    function draw() {
      calcBaseRadius();
      const currentTime = millis();
      deltaFrameTime = min(currentTime - lastFrameTime, 100);
      lastFrameTime = currentTime;
      smoothedFrameRate = lerp(smoothedFrameRate, frameRate(), 0.05);
      t += deltaFrameTime;
      rot += rotSpeed * deltaFrameTime;
      const centerX = width / 2,
        centerY = height / 2;
      drawRadialBackground();
      push();
      translate(centerX, centerY);
      rotate(rot);
      const targetPoints = smoothedFrameRate > 50 ? 720 : (smoothedFrameRate > 35 ? 400 : 250),
        minPoints = 800 + lobeCount * 80 + ribbonCount * 40,
        detailPoints = max(floor(targetPoints), minPoints),
        angleIncrement = TWO_PI / detailPoints,
        lobeMultiplier = lobeCount,
        turbMultiplier = turbulence;
        const i=hexToHsb(ribbonBaseColorHex)  || {h:0,s:0,b:0};
        const b=i.h,u=i.s,m=i.b;
      for (let l = 0; l < ribbonCount; l++) {
        const phase = t * 0.0002 + l * 0.3,
          hue = (b + sin(phase * 1.3 + l * 0.5) * 80 + 360) % 360;
        stroke(hue, u, m, 60);
        strokeWeight(0.28 + l * 0.4 * strokeBase);
        noFill();
        beginShape();
        for (let i = 0; i <= detailPoints; i++) {
          const a = angleIncrement * i,
            cosA = cos(a * lobeMultiplier),
            sinA = sin(a * lobeMultiplier),
            n = noise(cosA * turbMultiplier + phase, sinA * turbMultiplier + phase * 1.1),
            r = baseRadius + n * radiusScale + sinScale * sin(lobeMultiplier * a + phase + l),
            x = r * cos(a),
            y = r * sin(a);
          curveVertex(x, y)
        }
        endShape(CLOSE);
      }
      pop()
    }

    function keyPressed() {
      if (key === '0' || key === '3' || key === '6' || key === '9') {
        rotSpeed = 0;
      }
      if (key === '1') {
        lobeCount = max(3, lobeCount - 1);
      } else if (key === '2') {
        lobeCount = min(10, lobeCount + 1);
      }
      if (key === '4') {
        turbulence = max(0.1, turbulence - 0.05);
      } else if (key === '5') {
        turbulence = min(3.0, turbulence + 0.05);
      }
      if (key === '7') {
        ribbonCount = max(1, ribbonCount - 1);
      } else if (key === '8') {
        ribbonCount = min(20, ribbonCount + 1);
      }
      if (key === '+' || key === '=') {
        rotSpeed += 0.0001;
      } else if (key === '-') {
        rotSpeed = max(0, rotSpeed - 0.0001);
      }
    }
<\/script>
</body>
</html>`;

            // 3. Create a Blob and trigger download
            const blob = new Blob([htmlTemplate.trim()], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Function to update the iframe source with current parameters
        function updateIframeSource() {
            const currentLobeCount = controls.lobeCount.value;
            const currentTurbulence = controls.turbulence.value;
            const currentRibbonCount = controls.ribbonCount.value;
            const currentRotSpeed = controls.rotSpeed.value;
            const currentSeedValue = Math.floor(Math.random() * 1000000);
            const currentBgColor1 = controls.bgColor1.value.substring(1); // Remove #
            const currentBgColor2 = controls.bgColor2.value.substring(1); // Remove #
            const currentRibbonColor = controls.ribbonColor.value.substring(1); // Remove #


            const iframeSrc = `ORDTISM 1.html?lobeCount=${currentLobeCount}&turbulence=${currentTurbulence}&ribbonCount=${currentRibbonCount}&rotSpeed=${currentRotSpeed}&currentSeed=${currentSeedValue}&bgColor1=${currentBgColor1}&bgColor2=${currentBgColor2}&ribbonColor=${currentRibbonColor}`;
            iframe.src = iframeSrc;
            console.log("Derivitooor: Updating iframe source to:", iframeSrc);
        }

        // Add event listeners to controls to update iframe source
        for (const param in controls) {
            controls[param].addEventListener('input', (event) => {
                const value = event.target.value;
                if (valueDisplays[param]) {
                    // Format rotation speed nicely, others as is
                    valueDisplays[param].textContent = param === 'rotSpeed' ? parseFloat(value).toFixed(4) : value;
                }
                // Update iframe source on input change
                updateIframeSource();
            });
        }

        // --- Panel Toggling Logic ---
        function closePanel(panelId) {
            console.log(`Closing panel: ${panelId}`);
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.remove('panel-visible'); // Use classList
                // panel.style.display = 'none'; // Fallback if needed, but class should work
            }
        }

        function togglePanel(panelIdToShow) {
            console.log(`Toggling panel: ${panelIdToShow}`);
            const panelToShow = document.getElementById(panelIdToShow);
            const panelToHide = panelIdToShow === 'controls' ? colorControlsPanel : controlsPanel;

            if (panelToShow) {
                const isCurrentlyVisible = panelToShow.classList.contains('panel-visible');
                console.log(`Panel ${panelIdToShow} isCurrentlyVisible: ${isCurrentlyVisible}`);

                if (isCurrentlyVisible) {
                    console.log(`Hiding ${panelIdToShow}`);
                    panelToShow.classList.remove('panel-visible');
                } else {
                    console.log(`Showing ${panelIdToShow}, hiding ${panelToHide?.id}`);
                    panelToShow.classList.add('panel-visible');
                    if (panelToHide) {
                        panelToHide.classList.remove('panel-visible'); // Hide the other panel
                    }
                }
            } else {
                 console.error(`Panel with ID ${panelIdToShow} not found.`);
            }
        }

        if (mobileParamsBtn) {
            mobileParamsBtn.addEventListener('click', () => {
                console.log("Mobile Parameters button clicked");
                togglePanel('controls');
            });
        }
        if (mobileColorsBtn) {
            mobileColorsBtn.addEventListener('click', () => {
                console.log("Mobile Colors button clicked");
                togglePanel('color-controls');
            });
        }
        // Add event listeners for close buttons (handled via inline onclick for simplicity here)


        // --- Randomize Logic ---
        function randomizeParams() {
             // Generate random values within defined ranges
             const randomLobeCount = Math.floor(Math.random() * 15) + 1; // 1-15
            const randomTurbulence = (Math.random() * (3.0 - 0.1) + 0.1).toFixed(2); // 0.1-3.0
            const randomRibbonCount = Math.floor(Math.random() * 20) + 1; // 1-20
            let randomRotSpeed = (Math.random() * (0.001 - (-0.001)) + (-0.001)).toFixed(4); // -0.001 to 0.001
            randomRotSpeed = Math.max(0, parseFloat(randomRotSpeed)).toFixed(4); // Ensure not negative

            // Generate random hex colors
            const randomColor = () => '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            const randomBgColor1 = randomColor();
            const randomBgColor2 = randomColor();
            const randomRibbonColor = randomColor();


            // Update controls
            controls.lobeCount.value = randomLobeCount;
            controls.turbulence.value = randomTurbulence;
            controls.ribbonCount.value = randomRibbonCount;
            controls.rotSpeed.value = randomRotSpeed;
            controls.bgColor1.value = randomBgColor1;
            controls.bgColor2.value = randomBgColor2;
            controls.ribbonColor.value = randomRibbonColor;


            // Update displays
            valueDisplays.lobeCount.textContent = randomLobeCount;
            valueDisplays.turbulence.textContent = randomTurbulence;
            valueDisplays.ribbonCount.textContent = randomRibbonCount;
            valueDisplays.rotSpeed.textContent = randomRotSpeed;
            // No display for seed, just update input

            // Update iframe source after randomizing
            updateIframeSource();
        }

        // Add event listeners for randomize buttons
        if (randomizeButton) { // Desktop button
             randomizeButton.addEventListener('click', () => {
                 console.log("Desktop Randomize button clicked");
                 randomizeParams();
             });
        }
        if (mobileRandomizeBtn) { // Mobile button
             mobileRandomizeBtn.addEventListener('click', () => {
                 console.log("Mobile Randomize button clicked");
                 randomizeParams();
             });
        }

        if (downloadButton) {
            downloadButton.addEventListener('click', () => downloadArt(false));
        }
        if (downloadOrdinalButton) {
            downloadOrdinalButton.addEventListener('click', () => downloadArt(true));
        }

    </script>
</body>
</html>
